jQuery(function(c){function b(){if(!c("#challenge").val()){return}c.ajax(ajaxurl,{data:{action:"get-challenge","chal-id":c("#challenge").val()},beforeSend:n,complete:j,success:function(C){if(!u(C)){return}c("#name").val(C.name);c("#start-date").val(C.start);c("#end-date").val(C.end);c("#desc").text(C.desc);c("#act-count").text(C.act_count);c("#part-count").text(C.part_count);c("#approval").prop("checked",r(C.approval));if(c("#approval").is(":checked")){c("#link").html('<a href="/index.php/challenge-list/?chal='+C.short_link+'" target="_blank">'+C.short_link+"</a>")}else{c("#link").html('<a href="/index.php/challenge/?chal='+C.short_link+'" target="_blank">'+C.short_link+"</a>")}},error:function(E,C,D){console.error(D)},dataType:"json",method:"post"})}function i(){c.ajax(ajaxurl,{data:{action:"save-challenge","chal-id":c("#challenge").val(),name:c("#name").val(),"start-date":c("#start-date").val(),"end-date":c("#end-date").val(),desc:c("#desc").val(),approval:(c("#approval").is(":checked")?"1":"0")},beforeSend:n,complete:j,success:function(C){if(!u(C)){return}if(!c("#challenge").val()){c("#challenge").append("<option value='"+C.id+"' selected>"+C.name+"</option>")}c("#link").html('<a href="/index.php/challenge-list/?chal='+C.uid+'" target="_blank">'+C.uid+"</a>")},error:function(E,C,D){console.error(D)},dataType:"json",method:"post"})}function o(){if(!c("#challenge").val().length){return}if(!confirm("Are you sure you want to delete this challenge?")){return}c.ajax(ajaxurl,{data:{action:"delete-challenge","chal-id":c("#challenge").val(),security:c("#_wpnonce").val()},beforeSend:n,complete:j,success:function(C){if(!u(C)){return}c("#challenge option:selected").remove();e()},error:function(E,C,D){console.error(D)},dataType:"json",method:"post"})}function e(){c("#challenge,#name,#start-date,#end-date").val("");c("#approval").prop("checked",false);c("#act-count,#part-count").html(0);c("#link").html("");c("#desc").text("")}c("#challenge").change(b);c("#save-challenge").click(i);c("#delete-challenge").click(o);function l(){if(!c("#challenge_activities").val().length){return}c.ajax(ajaxurl,{data:{action:"get-activities","chal-id":c("#challenge_activities").val()},beforeSend:n,complete:j,success:function(C){if(!u(C)){return}if(c.fn.DataTable.isDataTable("#activity-table")){q.destroy();c("#activity-table").empty()}q=c("#activity-table").DataTable({data:C.data.slice(0),columns:C.columns.slice(0),paging:false,buttons:["copyHtml5","csv","excel","pdf","print"],dom:"Bfrtip"});c(".tooltip-field").tooltip({show:{effect:"slideDown",delay:100},hide:{effect:"slideUp",delay:250}});if(C.group_msg){c("#group-msg").show()}else{c("#group-msg").hide()}h()},error:function(E,C,D){console.error(D)},dataType:"json",method:"post"})}function x(){c("#msg").removeClass("err-msg");var C=c("#act-name").val().replace(/[^a-z0-9]/g,"");if(!w()){return}c.ajax(ajaxurl,{data:{action:"save-activity","chal-id":c("#challenge_activities").val(),"act-id":c("#act-id").val(),name:C,points:c("#act-pts").val(),type:c("#act-type").val(),question:c("#act-ques").val(),label:c("#act-labels").val(),min:c("#act-min").val(),max:c("#act-max").val(),"chal-max":c("#act-chal-max").val(),desc:c("#act-desc").val(),order:c("#act-order").val(),hidden:r(c("#act-hidden").is(":checked")),group:c("#act-group").val()},beforeSend:n,complete:j,success:function(F){if(!u(F)){return}var G=F.name;if(c("#act-hidden").is(":checked")){G="<i>"+F.name+"*</i>"}var E=c("#activity-table").DataTable();if(!c("#act-id").val()){E.row.add({order:c("#act-order").val(),type:c("#act-type option:selected").text(),name:G,points:c("#act-pts").val(),chal_max:(c("#act-chal-max").val()?c("#act-chal-max").val():0),question:F.question,desc:F.desc,group:F.group,extras:(c("#act-type").val()==="checkbox"||c("#act-type").val()==="radio"?F.label:(c("#act-min").val()?c("#act-min").val():0)+"/"+(c("#act-max").val()?c("#act-max").val():0)),action:"<i class='fas fa-edit' data-id='"+F.id+"'></i>&nbsp;&nbsp;<i class='far fa-trash-alt' data-id='"+F.id+"'></i>"}).draw(false)}else{var D=E.row(c("#t-row").val()).data();D.order=c("#act-order").val();D.type=c("#act-type option:selected").text();D.name=G;D.points=c("#act-pts").val();D.chal_max=(c("#act-chal-max").val()?c("#act-chal-max").val():0);D.question=F.question;D.desc=F.desc;D.group=F.group;D.extras=(c("#act-type").val()==="checkbox"||c("#act-type").val()==="radio"?F.label:(c("#act-min").val()?c("#act-min").val():0)+"/"+(c("#act-max").val()?c("#act-max").val():0));E.row(c("#t-row").val()).invalidate(D).draw()}if(F.group_msg){c("#group-msg").show()}else{c("#group-msg").hide()}h()},error:function(F,D,E){console.error(E)},dataType:"json",method:"post"})}function B(){c("#act-labels,#act-min,#act-max").hide();if(c("#act-type").val()=="checkbox"||c("#act-type").val()=="radio"){c("#act-labels").show()}else{if(c("#act-type").val()=="text"||c("#act-type").val()=="number"){c("#act-min,#act-max").show()}}}function a(){c.ajax(ajaxurl,{data:{action:"get-activity-details","act-id":c(this).data("id"),"chal-id":c("#challenge_activities").val()},beforeSend:n,complete:j,success:function(C){if(!u(C)){return}c("#t-row").val(C.order-1);c("#act-id").val(C.id);c("#act-type").val(C.type);c("#act-name").val(C.name);c("#act-pts").val(C.points);c("#act-chal-max").val(C.chal_max);c("#act-ques").val(C.question);c("#act-desc").val(C.desc);c("#act-group").val(C.group);c("#act-hidden").prop("checked",(r(C.hidden)?true:false));c("#act-order").val(C.order);c("#act-labels").val(C.label);c("#act-min").val(C.min);c("#act-max").val(C.max);B()},error:function(E,C,D){console.error(D)},dataType:"json",method:"post"})}function w(){var C=true;c("#msg span").remove();c("#msg").removeClass("err-msg");if(!c("#act-type").val()){c("#msg").append("<div>You need to select an activity type</div>");C=false}if(!c("#act-name").val()){c("#msg").append("<div>Please enter a name for the activity</div>");C=false}if(!c("#act-pts").val()&&!c("#act-hidden").is(":checked")){c("#msg").append("<div>Please enter a point value for this activity</div>");C=false}if(!c("#act-ques").val()){c("#msg").append("<div>Please enter a question to ask the user</div>");C=false}if(!c("#act-desc").val()){c("#msg").append("<div>Please enter a long description for the question</div>");C=false}if(!c("#act-order").val()){c("#msg").append("<div>Please enter a numeric order for the question to appear</div>");C=false}return C}function h(){c("#act-type,#act-name,#act-ques,#act-desc,#act-labels,#act-id,#act-group").val("");c("#act-pts,#act-chal-max,#act-order,#act-min,#act-max").val(0);c("#act-labels,#act-min,#act-max").hide();c("#act-pts,#act-chal-max").prop("disabled",false);c("#act-hidden").prop("checked",false);c(".fa-trash-alt").off("click");c(".fa-edit").off("click");c(".fa-trash-alt").click(function(){var C=c(this);c.ajax(ajaxurl,{data:{action:"delete-activity","act-id":c(this).data("id"),"chal-id":c("#challenge_activities").val(),security:c("#_wpnonce").val()},beforeSend:n,complete:j,success:function(D){if(!u(D)){return}q.row(c(C).closest("tr").index()).remove().draw()},error:function(F,D,E){console.error(E)},dataType:"json",method:"post"})});c(".fa-edit").click(a)}c("#save-activity").click(x);c("#challenge_activities").change(l);c("#act-type").change(B);c("#act-hidden").click(function(){c("#act-pts,#act-chal-max").prop("disabled",false);if(c(this).is(":checked")){c("#act-pts,#act-chal-max").val("0");c("#act-pts,#act-chal-max").prop("disabled",true)}});function m(){if(!c("#challenge_participants").val()){return}c.ajax(ajaxurl,{data:{action:"get-participants","chal-id":c("#challenge_participants").val()},beforeSend:n,complete:j,success:function(C){if(!u(C)){return}if(c.fn.DataTable.isDataTable("#participant-table")){q.destroy();c("#participant-table").empty()}q=c("#participant-table").DataTable({data:C.data.slice(0),columns:C.columns.slice(0),order:[[4,"desc"]],buttons:["copyHtml5","csv","excel","pdf","print"],dom:"Bfrtip"});c(".approve").click(g);c(".fa-trash-alt").click(y)},error:function(E,C,D){console.error(D)},dataType:"json",method:"post"})}function g(){var C=c(this).data("user-id");c.ajax(ajaxurl,{data:{action:"approve-participant","chal-id":c("#challenge_participants").val(),"user-id":C},beforeSend:n,complete:j,success:function(D){if(!u(D)){return}c(this).prop("checked",true)},error:function(F,D,E){console.error(E)},dataType:"json",method:"post"})}function y(){if(!c("#challenge_participants").val()){return}var C=c(this).data("user-id");c.ajax(ajaxurl,{data:{action:"remove-participant","chal-id":c("#challenge_participants").val(),"user-id":C,security:c("#_wpnonce").val()},beforeSend:n,complete:j,success:function(D){if(!u(D)){return}q.row().remove().draw()},error:function(F,D,E){console.error(E)},dataType:"json",method:"post"})}function s(){c.ajax(ajaxurl,{data:{action:"clear-participants","chal-id":c("#challenge_participants").val(),security:c("#_wpnonce").val()},beforeSend:n,complete:j,success:function(C){if(!u(C)){return}if(c.fn.DataTable.isDataTable("#participant-table")){q.destroy();c("#participant-table").empty()}},error:function(E,C,D){console.error(D)},dataType:"json",method:"post"})}function v(){if(!c("#challenge_participants").val()){return}var D=/^\d+$/;var C=true;c("#msg div").remove();if(!c("#member-id").val()||!c("#member-id").val().match(D)){c("#msg").append("<div>Member ID must be numeric</div>");C=false}if(!c("#user-name").val()){c("#msg").append("<div>Must add users name</div>");C=false}if(!c("#user-email").val()){c("#msg").append("<div>Must add the users email</div>");C=false}if(!C){c("#msg").show(300);c("#msg").addClass("err-msg");setTimeout(function(){c("#msg").hide(300)},3000);return C}c.ajax(ajaxurl,{data:{action:"add-participant","chal-id":c("#challenge_participants").val(),"member-id":c("#member-id").val(),"user-name":c("#user-name").val(),"user-email":c("#user-email").val()},beforeSend:n,complete:j,success:function(E){if(!u(E)){return}q.row.add({approved:"<input type='checkbox' class='approved' checked />",memberid:c("#member-id").val(),name:E.name,email:E.email,totalPoints:0,action:"<i class='far fa-trash-alt' title='Remove this participant from the activity' data-user-id='"+E.user_id+"'></i>"}).draw(false);c(".fa-trash-alt").off("click");c(".fa-trash-alt").on("click",y);c("#admin-add-participant").hide(300)},error:function(G,E,F){console.error(data.error)},dataType:"json",method:"post"})}c("#challenge_participants").change(m);c("#add-challenge-participant").click(function(){c("#admin-add-participant").toggle(300)});c("#add-participant").click(v);c("#clear-participants").click(s);function t(){if(!c("#participant-log").val()){return}c.ajax(ajaxurl,{data:{action:"get-log","chal-id":c("#participant-log").val()},beforeSend:n,complete:j,success:function(C){if(!u(C)){return}if(c.fn.DataTable.isDataTable("#participant-log-table")){q.destroy();c("#participant-log-table").empty()}q=c("#participant-log-table").DataTable({data:C.data.slice(0),columns:C.columns.slice(0),ordering:false,buttons:["copyHtml5","csv","excel","pdf","print"],dom:"Bfrtip",initComplete:function(){this.api().columns().every(function(){var E=this;var F=c(E.header()).text().slice(0);var D=c("<select><option value=''>"+F+"</option></select>").appendTo(c(E.header()).empty()).on("change",function(){var G=c.fn.dataTable.util.escapeRegex(c(this).val());E.search(G?"^"+G+"$":"",true,false).draw()});E.data().unique().sort().each(function(H,G){D.append("<option value='"+H+"'>"+H+"</option>")})})}});c("#participant-log-table tbody").on("click","i",z)},error:function(E,C,D){console.error(D)},dataType:"json",method:"post"})}function z(){var C=c(this);c.ajax(ajaxurl,{data:{action:"delete-participant-activity","act-id":c(this).data("act-id"),"user-id":c(this).data("user-id"),"log-date":c(this).data("log-date"),security:c("#_wpnonce").val()},beforeSend:n,complete:j,success:function(D){if(!u(D)){return}q.row().remove().draw()},error:function(F,D,E){console.error(E)},dataType:"json",method:"post"})}c("#participant-log").change(t);function r(C){if(C==undefined){return false}if(typeof C==="boolean"){return C}else{if(typeof C!=="string"){console.error("unknown type: "+typeof C);return false}}switch(C.toLowerCase().trim()){case"true":case"yes":case"1":return true;case"false":case"no":case"0":case null:return false;default:return Boolean(C)}}function u(D){c("#msg div").remove();c("#msg").removeClass("err-msg,warn-msg");var C=false;if(D=="0"){c("#msg").html("<div>There was an error</div>");c("#msg").addClass("err-msg");C=true}if(D.error){c("#msg").html("<div>"+D.error+"</div>");c("#msg").addClass("err-msg");C=true}if(D.warning){c("#msg").html("<div>"+D.warning+"</div>");c("#msg").addClass("warn-msg");C=true}if(D.success){c("#msg").html("<div>"+D.success+"</div>")}if(c("#msg").html()){c("#msg").show(300)}if(C){setTimeout(function(){c("#msg").hide(300);c("#msg").html("")},3000)}else{setTimeout(function(){c("#msg").hide(300);c("#msg").html("")},1500)}return !C}function d(){var C=c("#pt-widget-type").val();c("#pt-widget-results").html("");if(!c("#pt-widget-challenge").val()){return}else{if(C!="challenge"&&C!="participants"&&C!="log"&&C!="activities"){alert("Please select a valid report type to query");return}}c.ajax(ajaxurl,{data:{action:"pt-get-widget-data","chal-id":c("#pt-widget-challenge").val(),"report-type":C},beforeSend:n,complete:j,success:function(E){if(C=="challenge"){c("#pt-widget-results").html("<p class='close' style='margin-top:10px;'><b>Start</b>: "+E.start+"</p><p class='close'><b>End</b>: "+E.end+"</p><p class='close'><b>Participant Count</b>: "+E.p_count+"</p><p class='close'><b>Total Points</b>: "+E.total_points+"</p><p class='close'><b>Point Leader</b>: "+E.leader+" ("+E.leaders_points+")</p>")}else{if(C=="activities"){c("#pt-widget-results").html("<table width='100%'><thead><tr><th>Group</th><th>Name</th><th>Points</th><th>Total</th></tr></thead><tbody></tbody></table>");for(var D in E){c("#pt-widget-results tbody").append("<tr><td>"+E[D].group+"</td><td>"+E[D].name+"</td><td>"+E[D].points+"</td><td>"+E[D].pt+"</td></tr>")}}else{if(C=="participants"){c("#pt-widget-results").html("<table width='100%'><thead><tr><th>Name</th><th>Email</th><th>Approved</th><th>Points</th></tr></thead><tbody></tbody></table>");for(var D in E){c("#pt-widget-results tbody").append("<tr><td>"+E[D].name+"</td><td><a href='mailto:"+E[D].email+"'>"+E[D].email+"</a></td><td>"+(E[D].approved?"Yes":"No")+"</td><td>"+E[D].pt+"</td></tr>")}}else{if(C=="log"){}}}}},error:function(F,D,E){console.error(E)},dataType:"json",method:"post"})}function n(){c("#loading,#waiting").show();c("#waiting").animate({opacity:"0.5"},300,"linear")}function j(){c("#loading,#waiting").hide();c("#waiting").animate({opacity:"0"},300,"linear")}var k={lines:25,length:25,width:5,radius:50,scale:1,corners:1,color:"#000",opacity:0.25,rotate:0,direction:1,speed:0.5,trail:60,fps:20,zIndex:2000000000,className:"spin-thingy",top:"50%",left:"50%",shadow:false,hwaccel:false,position:"absolute",};var A,f,q,p;c("#start-date").datepicker({dateFormat:my_object.date_format,onSelect:function(D){var C=c("#end-date");var E=c(this).datepicker("getDate");C.datepicker("option","minDate",E)}});c("#end-date").datepicker({dateFormat:my_object.date_format});c("#act-group").autocomplete({source:function(D,C){if(!c("#challenge_activities").val()){return false}c.ajax(ajaxurl,{data:{action:"ac-group",keyword:c("#act-group").val(),"chal-id":c("#challenge_activities").val()},method:"post",success:function(E){C(JSON.parse(E))},error:function(E){console.error(E)}})},minLength:2,select:function(D,C){console.log("selected: "+C.item.value+" aka "+C.item.id)}});if(c("#loading").length){A=document.getElementById("loading");f=new Spinner(k).spin(A)}c(".tooltip-field").tooltip({show:{effect:"slideDown",delay:100},hide:{effect:"slideUp",delay:250}});c("#pt-widget-challenge,#pt-widget-type").change(d)});